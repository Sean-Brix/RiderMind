rules_version = '2';

// Firebase Storage rules for server-side uploads via Admin SDK
// This configuration allows Firebase Admin SDK (server-side) to perform operations
// while preventing unauthorized direct client access.
// 
// Security Model:
// - Server uses Firebase Admin SDK with service account (bypasses these rules)
// - Access control enforced by Express middleware (authenticate, requireRole)
// - Direct client-to-Firebase access is blocked (no Firebase Auth tokens issued)

service firebase.storage {
  match /b/{bucket}/o {
    
    // Allow Admin SDK operations (request.auth is null for Admin SDK)
    // Block any direct client requests (would have request.auth populated)
    match /{allPaths=**} {
      // Allow if no auth context (Admin SDK) OR if authenticated with admin claim
      // In practice, only Admin SDK will match since clients don't get Firebase tokens
      allow read, write: if request.auth == null || 
                            (request.auth != null && request.auth.token.admin == true);
    }
  }
}